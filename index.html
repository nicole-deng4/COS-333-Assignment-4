<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar's Office Class Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding:0;
            margin:0;
        }
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: #295078;
            color: white;
        }

        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: #295078;
            color: white;
            font-size: 1em;
        }
        .table-container {
            overflow-y: auto;
            width: 100%;
            padding: 10px; 
            margin: 0;
        }
        .btn-classid {
            background: #f2f2f2;
            border: 2px solid black;
            color: black;
            text-decoration: none;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 0;
        }

    </style>
</head>
<body>

    <header class="sticky-header p-12">
        <div class = "search-bar">
            <div class="container-fluid">
                <h1 class="text-center">Registrar's Office: Class Search</h1>
                <div class="row mb-4">
                    <div class= "col-md-3 col-12">
                        <input type="text" id="deptInput" class="form-control" placeholder="Department">
                    </div>
                    <div class="col-md-3 col-12">
                        <input type="text" id="coursenumInput" class="form-control" placeholder="Number">
                    </div>
                    <div class="col-md-3 col-12">
                        <input type="text" id="areaInput" class="form-control" placeholder="Area">
                    </div>
                    <div class="col-md-3 col-12">
                        <input type="text" id="titleInput" class="form-control" placeholder="Title">
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div style="padding-top: 105px; padding-bottom: 70px;">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-container">
                    <table id="overviewsTable" class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ClassId</th>
                                <th>Dept</th>
                                <th>Num</th>
                                <th>Area</th>
                                <th>Title</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="sticky-footer">
        <div class="container">
            <div class="text-center">
                <large class="text-white">Created by Ziya Momin and Nicole Deng</div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="classDetailsModal" tabindex="-1" aria-labelledby="classDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="classDetailsModalLabel">Registrar's Office</h4>
                    <button type="button" class="btn-close bg-red-600" label="Close"></button>
                </div>
                <div class="modal-body">
                    <h2>Class Details</h2>
                    <div class="table-responsive">
                        <table class="table table-striped" id="classDetailsTable">
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <h2>Course Details</h2>
                    <div class="table-responsive">
                        <table class="table table-striped" id="courseDetailsTable">
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentRequest = null;
        let debounceTimer = null;

        const deptInput = document.getElementById('deptInput');
        const coursenumInput = document.getElementById('coursenumInput');
        const areaInput = document.getElementById('areaInput');
        const titleInput = document.getElementById('titleInput');
        const overviewsTable = document.getElementById('overviewsTable').getElementsByTagName('tbody')[0];

        function cancelCurrentRequest() {
            if (currentRequest) {
                currentRequest.abort();
                currentRequest = null;
            }
        }

        function fetchOverviews() {
            cancelCurrentRequest();

            const dept = deptInput.value.trim();
            const coursenum = coursenumInput.value.trim();
            const area = areaInput.value.trim();
            const title = titleInput.value.trim();

            let url = '/regoverviews?';
            let first = true;
            if (dept) {
                url += (first ? '' : '&') + 'dept=' + encodeURIComponent(dept);
                first = false;
            }
            if (coursenum) {
                url += (first ? '' : '&') + 'coursenum=' + encodeURIComponent(coursenum);
                first = false;
            }
            if (area) {
                url += (first ? '' : '&') + 'area=' + encodeURIComponent(area);
                first = false;
            }
            if (title) {
                url += (first ? '' : '&') + 'title=' + encodeURIComponent(title);
                first = false;
            }

            const xhr = new XMLHttpRequest();
            currentRequest = xhr;

            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response[0] === true) {
                            displayOverviews(response[1]);
                        } else {
                            alert('Error: ' + response[1]);
                        }
                    } catch (e) {
                        alert('Error: Failed to parse response from server');
                    }
                } else {
                    alert('Error: Failed to fetch data from server');
                }
                currentRequest = null;
            };

            xhr.onerror = function() {
                alert('Error: Failed to fetch data from server');
                currentRequest = null;
            };

            xhr.onabort = function() {
                currentRequest = null;
            };

            xhr.send();
        }

        function displayOverviews(overviews) {
            overviewsTable.innerHTML = '';

            if (overviews.length === 0) {
                const row = overviewsTable.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.className = 'text-center text-muted py-3';
                cell.textContent = 'No classes found matching your criteria.';
                return;
            }

            overviews.forEach(function(overview) {
                const row = overviewsTable.insertRow();
                const classidCell = row.insertCell(0);
                const deptCell = row.insertCell(1);
                const coursenumCell = row.insertCell(2);
                const areaCell = row.insertCell(3);
                const titleCell = row.insertCell(4);

                // Create button for classid
                const button = document.createElement('button');
                button.id = 'button' + overview.classid;
                button.className = 'btn-classid';
                button.textContent = overview.classid;
                button.onclick = function() {
                    getResultsDetails(overview.classid);
                };
                classidCell.appendChild(button);

                deptCell.textContent = overview.dept || '';
                coursenumCell.textContent = overview.coursenum || '';
                areaCell.textContent = overview.area || '';
                titleCell.textContent = overview.title || '';
            });
        }

        function getResultsDetails(classid) {
            cancelCurrentRequest();

            const url = '/regdetails?classid=' + encodeURIComponent(classid);

            const xhr = new XMLHttpRequest();
            currentRequest = xhr;

            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response[0] === true) {
                            displayDetails(response[1]);
                        } else {
                            displayError(response[1]);
                        }
                        const modal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
                        modal.show();
                    } catch (e) {
                        displayError('Failed to parse response from server');
                        const modal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
                        modal.show();
                    }
                } else {
                    displayError('Failed to fetch data from server');
                    const modal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
                    modal.show();
                }
                currentRequest = null;
            };

            xhr.onerror = function() {
                displayError('Failed to fetch data from server');
                const modal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
                modal.show();
                currentRequest = null;
            };

            xhr.onabort = function() {
                currentRequest = null;
            };

            xhr.send();
        }

        function displayError(errorMessage) {
            const classDetailsTable = document.querySelector('#classDetailsTable tbody');
            const courseDetailsTable = document.querySelector('#courseDetailsTable tbody');

            classDetailsTable.innerHTML = '';
            courseDetailsTable.innerHTML = '';
            
            function addRow(tbody, label, value) {
                const row = tbody.insertRow();
                const labelCell = row.insertCell(0);
                const valueCell = row.insertCell(1);
                labelCell.innerHTML = '<strong>' + label + '</strong>';
                valueCell.textContent = value || '';
            }

            addRow(classDetailsTable, 'Error', errorMessage);
            addRow(courseDetailsTable, 'Error', errorMessage);
        }

        function displayDetails(details) {
            const classDetailsTable = document.querySelector('#classDetailsTable tbody');
            const courseDetailsTable = document.querySelector('#courseDetailsTable tbody');

            classDetailsTable.innerHTML = '';
            courseDetailsTable.innerHTML = '';
            function addRow(tbody, label, value) {
                const row = tbody.insertRow();
                const labelCell = row.insertCell(0);
                const valueCell = row.insertCell(1);
                labelCell.innerHTML = '<strong>' + label + '</strong>';
                valueCell.textContent = value || '';
            }

            addRow(classDetailsTable, 'Class Id', details.classid);
            addRow(classDetailsTable, 'Days', details.days || '');
            addRow(classDetailsTable, 'Start time', details.starttime || '');
            addRow(classDetailsTable, 'End time', details.endtime || '');
            addRow(classDetailsTable, 'Building', details.bldg || '');
            addRow(classDetailsTable, 'Room', details.roomnum || '');

            addRow(courseDetailsTable, 'Course Id', details.courseid);

            if (details.deptcoursenums && details.deptcoursenums.length > 0) {
                details.deptcoursenums.forEach(function(item) {
                    addRow(courseDetailsTable, 'Dept and Number', item.dept + ' ' + item.coursenum);
                });
            }

            addRow(courseDetailsTable, 'Area', details.area || '');
            addRow(courseDetailsTable, 'Title', details.title || '');
            addRow(courseDetailsTable, 'Description', details.descrip || '');
            addRow(courseDetailsTable, 'Prerequisites', details.prereqs || '');

            let profText = '';
            if (details.profnames && details.profnames.length > 0) {
                profText = details.profnames.join('<br>');
            }
            const profRow = courseDetailsTable.insertRow();
            const profLabelCell = profRow.insertCell(0);
            const profValueCell = profRow.insertCell(1);
            profLabelCell.innerHTML = '<strong>Professor</strong>';
            profValueCell.innerHTML = profText;
        }

        function debouncedFetchOverviews() {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }

            debounceTimer = setTimeout(function() {
                fetchOverviews();
                debounceTimer = null;
            }, 500);
        }

        deptInput.addEventListener('input', debouncedFetchOverviews);
        coursenumInput.addEventListener('input', debouncedFetchOverviews);
        areaInput.addEventListener('input', debouncedFetchOverviews);
        titleInput.addEventListener('input', debouncedFetchOverviews);

        window.addEventListener('load', function() {
            fetchOverviews();
        });
    </script>
</body>
</html>
