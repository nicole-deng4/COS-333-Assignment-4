<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar's Office Class Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #295078;
            color: white;
        }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #295078;
            color: white;
            font-size: 1em;
        }
        .table-container {
            overflow-y: auto;
            width: 100%;
            padding: 10px;
            margin: 0;
        }
        .btn-classid {
            background: #f2f2f2;
            border: 2px solid black;
            color: black;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 0;
        }
        header h1 {
            font-size: 2.5rem;
        }
        thead {
            background-color: white !important;
            color: black !important;
        }
    </style>
</head>
<body>

    <header class="header px-3 pb-3">
        <div class="search-bar">
            <div class="container-fluid">
                <h1 class="text-center" style="margin-top: 0; padding-top: 0;">Registrar's Office: Class Search</h1>
                <div class="row g-3 mb-3">
                    <div class="col-md-3 col-12">
                        <input type="text" id="deptInput" class="form-control" placeholder="Department">
                    </div>
                    <div class="col-md-3 col-12">
                        <input type="text" id="coursenumInput" class="form-control" placeholder="Number">
                    </div>
                    <div class="col-md-3 col-12">
                        <input type="text" id="areaInput" class="form-control" placeholder="Area">
                    </div>
                    <div class="col-md-3 col-12">
                        <input type="text" id="titleInput" class="form-control" placeholder="Title">
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div style="padding-top: 120px; padding-bottom: 70px;">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-container">
                    <table id="overviewsTable" class="table table-striped mb-0 align-middle">
                        <thead>
                            <tr>
                                <th>ClassId</th>
                                <th>Dept</th>
                                <th>Num</th>
                                <th>Area</th>
                                <th>Title</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col text-center">
                    <span class="text-white">Created by Ziya Momin and Nicole Deng</span>
                </div>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="classDetailsModal" tabindex="-1" aria-labelledby="classDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="classDetailsModalLabel">Registrar's Office</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h2>Class Details</h2>
                    <div class="table-responsive">
                        <table class="table table-striped" id="classDetailsTable">
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <h2>Course Details</h2>
                    <div class="table-responsive">
                        <table class="table table-striped" id="courseDetailsTable">
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
 </script>

 <script>
    'use strict';


    let overviewsRequest = null;
    let overviewsTimer = null;


    function displayOverviews(overviews) {
        let overviewsTbody =
            document.getElementById('overviewsTable').getElementsByTagName('tbody')[0];

        overviewsTbody.innerHTML = '';

        for (let i = 0; i < overviews.length; i += 1) {
        let overview = overviews[i];

        let row = overviewsTbody.insertRow();
        let classidCell = row.insertCell(0);
        let deptCell = row.insertCell(1);
        let coursenumCell = row.insertCell(2);
        let areaCell = row.insertCell(3);
        let titleCell = row.insertCell(4);

        let classid = overview.classid;
        let button = document.createElement('button');
        button.id = 'button' + classid;
        button.className = 'btn-classid';
        button.textContent = classid;
        button.addEventListener('click', function () {
        getResultsDetails(classid);
 });

        classidCell.appendChild(button);
        deptCell.textContent = overview.dept;
        coursenumCell.textContent = overview.coursenum;
        areaCell.textContent = overview.area || '';
        titleCell.textContent = overview.title || '';
 }
 }

 function handleOverviewsResponse() {
 if (this.status !== 200) {
 alert('Error: Failed to fetch data from server');
 overviewsRequest = null;
 return;
 }

 try {
 let response = JSON.parse(this.responseText);
 if (response[0] === true) {
 displayOverviews(response[1]);
 }
 else {
 alert('Error: ' + response[1]);
 }
 }
 catch (e) {
 alert('Error: Failed to parse response from server');
 }

 overviewsRequest = null;
 }

 function handleOverviewsError() {
 if (this.statusText !== 'abort') {
 alert('Error: Failed to fetch data from server');
 }
 overviewsRequest = null;
 }

 function getOverviews() {
 let deptInput = document.getElementById('deptInput');
 let coursenumInput = document.getElementById('coursenumInput');
 let areaInput = document.getElementById('areaInput');
 let titleInput = document.getElementById('titleInput');

 let dept = deptInput.value.trim();
 let coursenum = coursenumInput.value.trim();
 let area = areaInput.value.trim();
 let title = titleInput.value.trim();

 let url = '/regoverviews';
 let first = true;

 function addParam(name, value) {
 if (value === '') {
 return;
 }
 if (first) {
 url += '?';
 first = false;
 }
 else {
 url += '&';
 }
 url += name + '=' + encodeURIComponent(value);
 }

 addParam('dept', dept);
 addParam('coursenum', coursenum);
 addParam('area', area);
 addParam('title', title);

 if (overviewsRequest !== null) {
 overviewsRequest.abort();
 }

 overviewsRequest = new XMLHttpRequest();
 overviewsRequest.onload = handleOverviewsResponse;
 overviewsRequest.onerror = handleOverviewsError;
 overviewsRequest.open('GET', url);
 overviewsRequest.send();
 }

 function debouncedGetOverviews() {
 window.clearTimeout(overviewsTimer);
 overviewsTimer = window.setTimeout(getOverviews, 500);
 }

 function addDetailsRow(tbody, label, value) {
 let row = tbody.insertRow();
 let labelCell = row.insertCell(0);
 let valueCell = row.insertCell(1);
 labelCell.innerHTML = '<strong>' + label + '</strong>';
 valueCell.textContent = value || '';
 }

 function displayDetails(details) {
 let classDetailsTbody =
 document.getElementById('classDetailsTable').getElementsByTagName('tbody')[0];
 let courseDetailsTbody =
 document.getElementById('courseDetailsTable').getElementsByTagName('tbody')[0];

 classDetailsTbody.innerHTML = '';
 courseDetailsTbody.innerHTML = '';

 addDetailsRow(classDetailsTbody, 'Class Id', details.classid);
 addDetailsRow(classDetailsTbody, 'Days', details.days || '');
 addDetailsRow(classDetailsTbody, 'Start time', details.starttime || '');
 addDetailsRow(classDetailsTbody, 'End time', details.endtime || '');
 addDetailsRow(classDetailsTbody, 'Building', details.bldg || '');
 addDetailsRow(classDetailsTbody, 'Room', details.roomnum || '');

 addDetailsRow(courseDetailsTbody, 'Course Id', details.courseid);

 if (details.deptcoursenums && details.deptcoursenums.length > 0) {
 for (let i = 0; i < details.deptcoursenums.length; i += 1) {
 let item = details.deptcoursenums[i];
 addDetailsRow(
 courseDetailsTbody,
 'Dept and Number',
 item.dept + ' ' + item.coursenum
 );
 }
 }

 addDetailsRow(courseDetailsTbody, 'Area', details.area || '');
 addDetailsRow(courseDetailsTbody, 'Title', details.title || '');
 addDetailsRow(courseDetailsTbody, 'Description', details.descrip || '');
 addDetailsRow(courseDetailsTbody, 'Prerequisites', details.prereqs || '');

 let profText = '';
 if (details.profnames && details.profnames.length > 0) {
 profText = details.profnames.join('\n');
 }
 let profRow = courseDetailsTbody.insertRow();
 let profLabelCell = profRow.insertCell(0);
 let profValueCell = profRow.insertCell(1);
 profLabelCell.innerHTML = '<strong>Professor</strong>';
 profValueCell.innerHTML = profText.replace(/\n/g, '<br>');
 }

 function handleDetailsResponse() {
 if (this.status !== 200) {
 alert('Error: Failed to fetch data from server');
 return;
 }

 try {
 let response = JSON.parse(this.responseText);
 if (response[0] === true) {
 displayDetails(response[1]);
 let modalNode = document.getElementById('classDetailsModal');
 let modal = new bootstrap.Modal(modalNode);
 modal.show();
 }
 else {
 alert('Error: ' + response[1]);
 }
 }
 catch (e) {
 alert('Error: Failed to parse response from server');
 }
 }

 function handleDetailsError() {
 alert('Error: Failed to fetch data from server');
 }

 function getResultsDetails(classid) {
 let encodedClassid = encodeURIComponent(classid);
 let url = '/regdetails?classid=' + encodedClassid;

 let request = new XMLHttpRequest();
 request.onload = handleDetailsResponse;
 request.onerror = handleDetailsError;
 request.open('GET', url);
 request.send();
 }

 function setupSearchInputs() {
 let deptInput = document.getElementById('deptInput');
 let coursenumInput = document.getElementById('coursenumInput');
 let areaInput = document.getElementById('areaInput');
 let titleInput = document.getElementById('titleInput');

 deptInput.addEventListener('input', debouncedGetOverviews);
 coursenumInput.addEventListener('input', debouncedGetOverviews);
 areaInput.addEventListener('input', debouncedGetOverviews);
 titleInput.addEventListener('input', debouncedGetOverviews);
 }

 function setup() {
 setupSearchInputs();
 getOverviews();
 }

 document.addEventListener('DOMContentLoaded', setup);
 </script>
</body>
</html>

