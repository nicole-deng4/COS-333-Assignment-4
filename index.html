<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar's Office Class Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <div>
            <h1>Registrar's Office: Class Search</h1>
        </div>
    </header>

    <main>
        <div>
            <div>
                <div>
                    <label for="deptInput">Department:</label>
                    <input type="text" id="deptInput" placeholder="Department">
                </div>
                <div>
                    <label for="coursenumInput">Number:</label>
                    <input type="text" id="coursenumInput" placeholder="Number">
                </div>
                <div>
                    <label for="areaInput">Area:</label>
                    <input type="text" id="areaInput" placeholder="Area">
                </div>
                <div>
                    <label for="titleInput">Title:</label>
                    <input type="text" id="titleInput" placeholder="Title">
                </div>
            </div>

            <div>
                <table id="overviewsTable">
                    <thead>
                        <tr>
                            <th><strong>ClassId</strong></th>
                            <th><strong>Dept</strong></th>
                            <th><strong>Num</strong></th>
                            <th><strong>Area</strong></th>
                            <th><strong>Title</strong></th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer>
        <div>
            <p>Created by Ziya Momin and Nicole Deng.</p>
        </div>
    </footer>

    <div class="modal fade" id="classDetailsModal" tabindex="-1" aria-labelledby="classDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="classDetailsModalLabel">Class Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Class Details</h6>
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered" id="classDetailsTable">
                            <tbody>
                            </tbody>
                        </table>
                    </div>

                    <h6>Course Details</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="courseDetailsTable">
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentRequest = null;
        let debounceTimer = null;

        const deptInput = document.getElementById('deptInput');
        const coursenumInput = document.getElementById('coursenumInput');
        const areaInput = document.getElementById('areaInput');
        const titleInput = document.getElementById('titleInput');
        const overviewsTable = document.getElementById('overviewsTable').getElementsByTagName('tbody')[0];

        function cancelCurrentRequest() {
            if (currentRequest) {
                currentRequest.abort();
                currentRequest = null;
            }
        }

        function fetchOverviews() {
            cancelCurrentRequest();

            const dept = deptInput.value.trim();
            const coursenum = coursenumInput.value.trim();
            const area = areaInput.value.trim();
            const title = titleInput.value.trim();

            let url = '/regoverviews?';
            let first = true;
            if (dept) {
                url += (first ? '' : '&') + 'dept=' + encodeURIComponent(dept);
                first = false;
            }
            if (coursenum) {
                url += (first ? '' : '&') + 'coursenum=' + encodeURIComponent(coursenum);
                first = false;
            }
            if (area) {
                url += (first ? '' : '&') + 'area=' + encodeURIComponent(area);
                first = false;
            }
            if (title) {
                url += (first ? '' : '&') + 'title=' + encodeURIComponent(title);
                first = false;
            }

            const xhr = new XMLHttpRequest();
            currentRequest = xhr;

            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response[0] === true) {
                            displayOverviews(response[1]);
                        } else {
                            alert('Error: ' + response[1]);
                        }
                    } catch (e) {
                        alert('Error: Failed to parse response from server');
                    }
                } else {
                    alert('Error: Failed to fetch data from server');
                }
                currentRequest = null;
            };

            xhr.onerror = function() {
                alert('Error: Failed to fetch data from server');
                currentRequest = null;
            };

            xhr.onabort = function() {
                currentRequest = null;
            };

            xhr.send();
        }

        function displayOverviews(overviews) {
            // Clear existing rows
            overviewsTable.innerHTML = '';

            if (overviews.length === 0) {
                const row = overviewsTable.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.textContent = 'No classes found.';
                return;
            }

            overviews.forEach(function(overview) {
                const row = overviewsTable.insertRow();
                const classidCell = row.insertCell(0);
                const deptCell = row.insertCell(1);
                const coursenumCell = row.insertCell(2);
                const areaCell = row.insertCell(3);
                const titleCell = row.insertCell(4);

                // Create button for classid
                const button = document.createElement('button');
                button.id = 'button' + overview.classid;
                button.textContent = overview.classid;
                button.onclick = function() {
                    getResultsDetails(overview.classid);
                };
                classidCell.appendChild(button);

                deptCell.textContent = overview.dept || '';
                coursenumCell.textContent = overview.coursenum || '';
                areaCell.textContent = overview.area || '';
                titleCell.textContent = overview.title || '';
            });
        }

        function getResultsDetails(classid) {
            // Cancel any existing request
            cancelCurrentRequest();

            const url = '/regdetails?classid=' + encodeURIComponent(classid);

            const xhr = new XMLHttpRequest();
            currentRequest = xhr;

            xhr.open('GET', url, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response[0] === true) {
                            displayDetails(response[1]);
                            const modal = new bootstrap.Modal(document.getElementById('classDetailsModal'));
                            modal.show();
                        } else {
                            alert('Error: ' + response[1]);
                        }
                    } catch (e) {
                        alert('Error: Failed to parse response from server');
                    }
                } else {
                    alert('Error: Failed to fetch data from server');
                }
                currentRequest = null;
            };

            xhr.onerror = function() {
                alert('Error: Failed to fetch data from server');
                currentRequest = null;
            };

            xhr.onabort = function() {
                currentRequest = null;
            };

            xhr.send();
        }

        function displayDetails(details) {
            const classDetailsTable = document.querySelector('#classDetailsTable tbody');
            const courseDetailsTable = document.querySelector('#courseDetailsTable tbody');

            classDetailsTable.innerHTML = '';
            courseDetailsTable.innerHTML = '';
            // Populate class details table
            function addRow(tbody, label, value) {
                const row = tbody.insertRow();
                const labelCell = row.insertCell(0);
                const valueCell = row.insertCell(1);
                labelCell.innerHTML = '<strong>' + label + '</strong>';
                valueCell.textContent = value || '';
            }

            addRow(classDetailsTable, 'Class Id', details.classid);
            addRow(classDetailsTable, 'Days', details.days || '');
            addRow(classDetailsTable, 'Start time', details.starttime || '');
            addRow(classDetailsTable, 'End time', details.endtime || '');
            addRow(classDetailsTable, 'Building', details.bldg || '');
            addRow(classDetailsTable, 'Room', details.roomnum || '');

            addRow(courseDetailsTable, 'Course Id', details.courseid);

            if (details.deptcoursenums && details.deptcoursenums.length > 0) {
                details.deptcoursenums.forEach(function(item) {
                    addRow(courseDetailsTable, 'Dept and Number', item.dept + ' ' + item.coursenum);
                });
            }

            addRow(courseDetailsTable, 'Area', details.area || '');
            addRow(courseDetailsTable, 'Title', details.title || '');
            addRow(courseDetailsTable, 'Description', details.descrip || '');
            addRow(courseDetailsTable, 'Prerequisites', details.prereqs || '');

            let profText = '';
            if (details.profnames && details.profnames.length > 0) {
                profText = details.profnames.join('<br>');
            }
            const profRow = courseDetailsTable.insertRow();
            const profLabelCell = profRow.insertCell(0);
            const profValueCell = profRow.insertCell(1);
            profLabelCell.innerHTML = '<strong>Professor</strong>';
            profValueCell.innerHTML = profText;
        }

        function debouncedFetchOverviews() {
            // Clear existing timer
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }

            debounceTimer = setTimeout(function() {
                fetchOverviews();
                debounceTimer = null;
            }, 500);
        }

        deptInput.addEventListener('input', debouncedFetchOverviews);
        coursenumInput.addEventListener('input', debouncedFetchOverviews);
        areaInput.addEventListener('input', debouncedFetchOverviews);
        titleInput.addEventListener('input', debouncedFetchOverviews);

        window.addEventListener('load', function() {
            fetchOverviews();
        });
    </script>
</body>
</html>
